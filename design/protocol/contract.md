# design/protocol/contract.md

## 목적
v0.3.0에서 외부와 맞닿는 인터페이스를 고정한다. CLI 옵션, 카메라 투영 규칙, 멀티샘플링 전략, PPM 출력 형식, 결정성 규칙을 본 문서에 정의하며 구현과 테스트는 본 규약을 기준으로 한다.

## 대상 버전
- 버전: v0.3.0
- 범위: 단일 구 노멀 기반 색상 이미지 생성 CLI (카메라 FOV/종횡비 + 멀티샘플링 안티앨리어싱)

## CLI 규약
- 실행 파일: `raytracer`
- 입력이 없어도 동작하며 기본값으로 렌더링한다.
- 지원 옵션(순서 무관):
  - `--width <정수>`: 이미지 너비(픽셀). 기본값 256. 1 이상 정수만 허용.
  - `--height <정수>`: 이미지 높이(픽셀). 기본값 256. 1 이상 정수만 허용.
  - `--spp <정수>`: 픽셀당 샘플 수(samples per pixel). 기본값 10. 1 이상 정수만 허용.
  - `--seed <정수>`: 난수 시드. 기본값 1. 0 이상 32비트 정수만 허용하며 동일 시드는 동일 결과를 보장한다.
  - `--output <경로>`: 출력 대상. 기본값 `-` 이며, `-`는 표준 출력으로 기록한다. 파일 경로가 주어지면 동일 경로에 덮어쓴다.
- 잘못된 옵션이나 값(예: 누락된 파라미터, 허용 범위 밖 값) 입력 시:
  - 표준 오류로 한국어 오류 메시지를 한 줄 출력하고 종료 코드 1을 반환한다.
  - 어떠한 부분 출력도 생성하지 않는다.

## 카메라 및 샘플링 규약
- 카메라
  - 원점(origin): `(0, 0, 0)`
  - 초점 거리(focal length): `1.0`
  - 수직 시야각(vertical FOV): `90도`
  - 종횡비(aspect ratio): `width / height`
  - 뷰포트 높이: `2 * tan(FOV/2)`
  - 뷰포트 너비: `aspect_ratio * viewport_height`
  - 수평 벡터: `(viewport_width, 0, 0)`
  - 수직 벡터: `(0, viewport_height, 0)`
  - 좌하단 코너: `origin - horizontal/2 - vertical/2 - (0, 0, focal_length)`
- 픽셀 좌표계
  - 입력 픽셀 좌표 `(x, y)`에서 `y=0`은 상단 행을 의미한다.
- 멀티샘플링
  - 픽셀당 `samples_per_pixel`번 랜덤 샘플링한다.
  - 각 샘플에 대해 정규화 좌표를 계산한다.
    - `u = (width == 1) ? 0.5 : (x + rand01) / (width - 1)`
    - `v = (height == 1) ? 0.5 : (height - 1 - y + rand01) / (height - 1)`
    - `rand01`은 `[0, 1)` 범위 균일 분포 난수다.
  - 레이 방향: `dir = lower_left_corner + u * horizontal + v * vertical - origin`
  - 색상 샘플을 모두 합산한 뒤 `samples_per_pixel`로 나누어 평균을 만든다(감마 보정 없음).

## RNG 및 결정성 규칙
- 난수 생성: `std::mt19937` + `std::uniform_real_distribution<double>(0.0, 1.0)`을 사용한다.
- 초기 시드: `--seed` 값으로 생성자를 초기화한다.
- 동일한 입력(옵션, 시드)에서는 항상 동일한 PPM 문자열을 생성한다.
- 테스트는 동일 시드 2회 실행 결과 문자열을 비교한다.

## PPM(P3) 출력 규약
- 포맷: ASCII PPM (P3)
- 헤더:
  1. 첫 줄: `P3`
  2. 둘째 줄: `<width> <height>` (공백 하나 구분)
  3. 셋째 줄: `255`
- 본문:
  - 픽셀 순서: 위에서 아래로, 각 행은 왼쪽에서 오른쪽으로 진행한다.
  - 각 픽셀은 `R G B` 세 값으로 이루어진 한 줄로 기록하며, 값 사이에는 공백 하나만 둔다.
  - 모든 줄 끝에는 개행(\n)을 넣는다. 마지막 픽셀 뒤에도 개행을 유지한다.
- 색상 생성 규칙(결정적):
  - 장면: 중심 `(0, 0, -1)`, 반지름 `0.5`인 구 1개.
  - 구 교차 테스트:
    - `dot(dir, dir) * t^2 + 2 * dot(oc, dir) * t + dot(oc, oc) - r^2 = 0` (단, `oc = origin - center`)
    - 근 판별식 `discriminant = b^2 - a*c` (여기서 `a = dot(dir, dir)`, `b = dot(oc, dir)`, `c = dot(oc, oc) - r^2`)
    - `discriminant < 0`이면 미교차, 배경색 사용
    - `discriminant >= 0`이면 `(-b - sqrt(discriminant)) / a`, 필요 시 `(-b + sqrt(discriminant)) / a` 중 `t > 0`이며 가장 작은 값을 채택한다.
    - 교차점 `p = r(t)`에서 법선 `n = (p - center) / r`
    - 레이 방향과 법선 내적이 양수이면 내부에서 나간 것으로 간주하고 `n = -n`으로 정규화한 뒤 색을 계산한다.
  - 색상 구성:
    - 구에 맞으면 `c = 0.5 * (n + (1,1,1))` (각 성분 0..1 범위)
    - 미교차 시 배경: `unit_dir = dir / |dir|`, `t = 0.5 * (unit_dir.y + 1.0)`, `c = (1.0 - t) * (1,1,1) + t * (0.5, 0.7, 1.0)`
    - 최종 채널 값: `channel = round(255 * clamp(c, 0, 0.999))`
    - `round`는 `std::lround`, `clamp`는 [0, 0.999] 구간에 제한한다.

## 출력/파일 정책
- `--output -` 또는 미지정 시 표준 출력으로만 기록한다.
- 파일로 기록 시 ASCII 텍스트만 생성하며 바이너리 파일은 생성하지 않는다.
- 렌더 산출물(.ppm 등)은 저장할 수 있으나 저장한 파일은 커밋 금지이다.

## 종료 코드
- 정상 종료: 0
- 입력 오류 등 사용법 위반: 1
- 파일 기록 실패: 2 (에러 메시지 후 종료)
