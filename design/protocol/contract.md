# design/protocol/contract.md

## 목적
v0.9.0에서 Cornell smoke 장면을 결정적으로 렌더링하는 외부 인터페이스를 고정한다. Quad/Box/변환을 그대로 사용하되 Box를 경계로 하는 ConstantMedium 볼륨을 추가해 연기 효과를 표현하며, CLI 옵션과 PPM 출력 규약은 본 문서를 따른다.

## 대상 버전
- 버전: v0.9.0
- 범위: 고정 시드 기반 Cornell smoke 렌더링(CLI 입력이 없어도 실행) + Quad/Box/Translate/RotateY + ConstantMedium 볼륨 두 개

## CLI 규약
- 실행 파일: `raytracer`
- 입력이 없어도 동작하며 기본값으로 렌더링한다.
- 지원 옵션(순서 무관):
  - `--width <정수>`: 이미지 너비(픽셀). 기본값 256. 1 이상 정수만 허용.
  - `--height <정수>`: 이미지 높이(픽셀). 기본값 256. 1 이상 정수만 허용.
  - `--spp <정수>`: 픽셀당 샘플 수(samples per pixel). 기본값 10. 1 이상 정수만 허용.
  - `--max-depth <정수>`: rayColor 재귀 최대 깊이. 기본값 20. 1 이상 정수만 허용하며 0 이하면 오류로 처리한다.
  - `--seed <정수>`: 난수 시드. 기본값 1. 0 이상 32비트 정수만 허용하며 동일 시드는 동일 결과를 보장한다.
  - `--output <경로>`: 출력 대상. 기본값 `-` 이며, `-`는 표준 출력으로 기록한다. 파일 경로가 주어지면 동일 경로에 덮어쓴다.
- 잘못된 옵션이나 값(예: 누락된 파라미터, 허용 범위 밖 값) 입력 시:
  - 표준 오류로 한국어 오류 메시지를 한 줄 출력하고 종료 코드 1을 반환한다.
  - 어떠한 부분 출력도 생성하지 않는다.
- 조리개(aperture)와 셔터 시간은 코드에 고정된 값으로 사용하며 CLI 옵션으로 제공하지 않는다.

## 카메라 및 샘플링 규약
- 카메라 배치
  - 시점(lookfrom): `(278, 278, -800)`
  - 목표(lookat): `(278, 278, 0)`
  - 업 벡터(vup): `(0, 1, 0)`
  - 수직 시야각(vertical FOV): `40도`
  - 종횡비(aspect ratio): `width / height`
  - 포커스 거리: `|lookfrom - lookat|`
  - 조리개(aperture): `0.0` → defocus blur 없음
- 시간 샘플링
  - 셔터 오픈/클로즈: `[time0, time1] = [0.0, 0.0]`으로 고정한다(모션 블러 없음).
  - 산란 레이는 입력 레이의 시간을 그대로 유지하며 모든 레이는 시간 0을 사용한다.
- 픽셀 좌표계
  - 입력 픽셀 좌표 `(x, y)`에서 `y=0`은 상단 행을 의미한다.
- 멀티샘플링
  - 픽셀당 `samples_per_pixel`번 랜덤 샘플링한다.
  - 각 샘플에 대해 정규화 좌표를 계산한다.
    - `u_norm = (width == 1) ? 0.5 : (x + rand01) / (width - 1)`
    - `v_norm = (height == 1) ? 0.5 : (height - 1 - y + rand01) / (height - 1)`
    - `rand01`은 `[0, 1)` 범위 균일 분포 난수다.
  - defocus 없이 샘플링한 레이를 생성하고 모든 색상 샘플을 합산한 뒤 `samples_per_pixel`로 나눈다.

## RNG 및 결정성 규칙
- 난수 생성: `std::mt19937` + `std::uniform_real_distribution<double>(0.0, 1.0)`을 사용한다.
- 픽셀 좌표 샘플링 → 볼륨 내 산란 거리 샘플링 → 재질 산란 순으로 단일 생성기가 직렬 소비된다.
- 초기 시드: `--seed` 값으로 생성자를 초기화한다.
- 동일한 입력(옵션, 시드)에서는 항상 동일한 PPM 문자열을 생성한다.
- 테스트는 동일 시드 2회 실행 결과 문자열을 비교한다.

## rayColor 재귀 규약
- `max_depth`는 CLI/옵션으로 입력받는다. 재귀 깊이가 0 이하가 되면 `(0,0,0)`을 반환하여 추가 기여를 차단한다.
- 히트 시: 재질이 방출하는 색상을 `emitted`라 할 때,
  - `Scatter`가 새로운 레이와 감쇠(attenuation)를 반환하면 `emitted + attenuation * rayColor(scattered, depth-1)`을 반환한다.
  - 산란이 발생하지 않더라도 `emitted`는 누적한다(발광 광원).
- 미히트 시: Cornell Box는 닫힌 장면이므로 `(0,0,0)` 배경을 반환한다.

## 재질/볼륨 규약
- 공통: `Scatter`는 입력 레이, 교차 정보, RNG를 받아 산란 레이와 감쇠 색을 결정한다. 산란 레이는 입력 레이의 시간값을 그대로 유지한다.
- Lambertian(diffuse):
  - 감쇠: 고정 알베도 색상.
  - 산란 방향: 법선 + 단위 구 내부 임의 벡터. 방향이 거의 0에 가까우면 법선을 사용한다.
- Metal:
  - 감쇠: 금속 알베도 색상.
  - 산란 방향: 입력 레이를 법선에 대해 반사한 뒤 `fuzz`(0~1) 배의 단위 구 무작위 벡터를 더한다. 산란 방향이 법선과 같은 쪽을 향하지 않으면 산란 실패로 간주한다.
- Dielectric:
  - 파라미터: 굴절률 `refraction_index`.
  - 법선 방향에 따라 굴절률 비율을 `eta = front_face ? (1.0 / refraction_index) : refraction_index`로 사용한다.
  - 전반사 조건 `eta * sin(theta) > 1`이면 반사만 수행한다.
  - 슐릭 근사 `R(theta) = r0 + (1-r0)*(1-cos(theta))^5`, `r0=((1-eta)/(1+eta))^2`를 사용해 반사/굴절을 선택한다.
  - 감쇠는 `(1,1,1)`을 사용한다.
- DiffuseLight(발광):
  - 산란하지 않으며 `Scatter`는 항상 false를 반환한다.
  - `Emitted(u, v, p)`는 `(front_face ? emit_color : (0,0,0))`을 반환한다. emit_color는 생성자 입력 색상이다.
- Isotropic(볼륨 위상 함수):
  - 감쇠: 입력 텍스처(단색 포함) 샘플 값.
  - 산란 방향: 단위 구 내부 임의 벡터를 사용하며 법선 제약이 없다.

## 볼륨 규약
- ConstantMedium은 경계 Hittable 내부에서 지수 분포로 산란 거리를 샘플링한다.
- 밀도 `density`에 대해 `-ln(rand01) / density`로 거리를 얻고, 경계 내부 거리를 초과하면 미히트로 처리한다.
- 충돌 시 `HitRecord`의 위치는 샘플 지점이며, 법선은 위상 함수에 영향이 없으므로 `(1,0,0)`을 사용하고 `front_face=true`로 고정한다.
- 텍스처는 Isotropic 위상 함수에 전달되어 감쇠 색을 결정한다.

## PPM(P3) 출력 규약
- 포맷: ASCII PPM (P3)
- 헤더:
  1. 첫 줄: `P3`
  2. 둘째 줄: `<width> <height>` (공백 하나 구분)
  3. 셋째 줄: `255`
- 본문:
  - 픽셀 순서: 위에서 아래로, 각 행은 왼쪽에서 오른쪽으로 진행한다.
  - 각 픽셀은 `R G B` 세 값으로 이루어진 한 줄로 기록하며, 값 사이에는 공백 하나만 둔다.
  - 모든 줄 끝에는 개행(\n)을 넣는다. 마지막 픽셀 뒤에도 개행을 유지한다.
- 색상 생성 규칙(결정적):
  - 장면: 555 단위 Cornell Box이며 내부 두 상자가 ConstantMedium 역할을 한다.
  - 재질 정의
    - `Lambertian red = (0.65, 0.05, 0.05)`
    - `Lambertian green = (0.12, 0.45, 0.15)`
    - `Lambertian white = (0.73, 0.73, 0.73)`
    - `DiffuseLight light = (15.0, 15.0, 15.0)`
  - 벽/천장/바닥/뒤쪽은 Quad로 구성하며 모든 면이 내부를 향하도록 법선을 설정한다.
    - 오른쪽 벽(x=555): `Quad(q=(555,0,0), u=(0,0,555), v=(0,555,0), material=green)`
    - 왼쪽 벽(x=0): `Quad(q=(0,0,0), u=(0,555,0), v=(0,0,555), material=red)`
    - 천장(y=555): `Quad(q=(0,555,0), u=(555,0,0), v=(0,0,555), material=white)`
    - 바닥(y=0): `Quad(q=(0,0,0), u=(555,0,0), v=(0,0,555), material=white)`
    - 뒤쪽 면(z=555): `Quad(q=(0,0,555), u=(555,0,0), v=(0,555,0), material=white)`
  - 광원: 천장 안쪽 area light Quad(법선은 -y).
    - `Quad(q=(213,554,227), u=(130,0,0), v=(0,0,105), material=light)`
  - 볼륨 경계: Box로 정의된 경계에 ConstantMedium을 적용한다.
    - 첫 번째 볼륨: `Box(min=(0,0,0), max=(165,165,165))` → `RotateY(-18°)` → `Translate((130,0,65))` 후 `density=0.01`, 색상 `(0,0,0)`
    - 두 번째 볼륨: `Box(min=(0,0,0), max=(165,330,165))` → `RotateY(15°)` → `Translate((265,0,295))` 후 `density=0.01`, 색상 `(1,1,1)`
  - Quad hit 판정: 평면 교차 후 Quad 내부를 barycentric 검사로 확인하며, `t_min=0.001`, `t_max=+∞`를 사용한다.
  - Box/Quad 경계: AABB를 반환하며 두께 0인 축과 무관하게 1e-4 패딩을 적용한다.
  - 표면 방향: `front_face`는 레이 방향과 법선 내적 부호로 결정하며, 내부에서 나가는 경우 법선을 뒤집는다.
- 배경색: `(0,0,0)`
  - rayColor: 앞서 정의한 재질 규약과 재귀 규칙을 따른다.
  - 감마 보정: 픽셀 평균 색상 `c`에 대해 각 채널을 `gamma=2.0`으로 보정한다(`corrected = sqrt(c)`), 이후 [0, 0.999]로 클램프한다.
  - 최종 채널 값: `channel = round(255 * corrected)`이며 `round`는 `std::lround`를 사용한다.

## 출력/파일 정책
- `--output -` 또는 미지정 시 표준 출력으로만 기록한다.
- 파일로 기록 시 ASCII 텍스트만 생성하며 바이너리 파일은 생성하지 않는다.
- 렌더 산출물(.ppm 등)은 저장할 수 있으나 저장한 파일은 커밋 금지이다.

## 종료 코드
- 정상 종료: 0
- 입력 오류 등 사용법 위반: 1
- 파일 기록 실패: 2 (에러 메시지 후 종료)
